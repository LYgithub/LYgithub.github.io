---
title: å•ä¾‹è®¾è®¡æ¨¡å¼
categories: è®¾è®¡æ¨¡å¼
abbrlink: cd333c07
date: 2020-07-09 10:16:09
tags:
	- è®¾è®¡æ¨¡å¼
	- å•ä¾‹æ¨¡å¼
---

> æœ¬æ–‡æ€»ç»“äº†å•ä¾‹è®¾è®¡æ¨¡å¼çš„åŸºæœ¬å†…å®¹ï¼Œå¹¶ğŸ“Enumã€åºåˆ—åŒ–ç­‰å†…å®¹ã€‚

<!-- more -->

## å®šä¹‰
ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹

### æ‡’æ±‰å¼

1ï¼‰çº¿ç¨‹å®‰å…¨
2ï¼‰åŠ é”ä¼˜åŒ–=> double check
3ï¼‰ç¼–è¯‘å™¨ï¼ˆJITï¼‰ï¼ŒCPU æœ‰å¯èƒ½å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œå¯¼è‡´ä½¿ç”¨åˆ°å°šæœªåˆå§‹åŒ–çš„å®ä¾‹ã€‚
	
- å¯¹è±¡åˆ›å»ºçš„æ­¥éª¤: åˆ†é…ç©ºé—´ => åˆå§‹åŒ– => å¼•ç”¨èµ‹å€¼ åœ¨ç¼–è¯‘æ—¶ ç¬¬2ã€3æ­¥æ˜¯å¯ä»¥äº’æ¢çš„
- å½“æ­¥éª¤äº’æ¢ï¼Œå…ˆè¿›è¡Œå¼•ç”¨èµ‹å€¼ï¼Œå½“å¦ä¸€ä¸ªéœ€è¦è·å–æ—¶ï¼Œç”±äºè¿˜æœªè¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿ`ç©ºæŒ‡é’ˆå¼‚å¸¸`ã€‚
- æ‰€ä»¥éœ€è¦ é€šè¿‡æ·»åŠ  `volatile`å…³é”®å­—è¿›è¡Œä¿®é¥°ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’ã€‚

#### ä¼˜åŒ–è¿‡ç¨‹

- åŸºæœ¬

```java
public class LazySingleton {
    private static LazySingleton instance;

    //åˆ›å»ºç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢ä½¿ç”¨ new åˆ›å»º
    private LazySingleton(){}

    public static LazySingleton getInstance(){
        if(instance == null){
            try {
                Thread.sleep(20);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            instance = new LazySingleton();
        }
        return instance;
    }
}

```
- é—®é¢˜

å½“ä¸¤ä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶è¿›å…¥ if ï¼Œå°±ä¼šåˆ›å»ºä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ã€‚

- è§£å†³ï¼šæ·»åŠ ç¨‹åºğŸ”’
```java
public synchronized static LazySingleton getInstance(){
        if(instance == null){
            try {
                Thread.sleep(20);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            instance = new LazySingleton();
        }
        return instance;
    }
```

- é—®é¢˜ : å½“åˆ›å»ºå®ä¾‹å¯¹è±¡åï¼Œä¸æ–­è·å–ä¼šé™ä½è·å–æ•ˆç‡(ä¸æ–­åŠ é”)ã€‚
- è§£å†³ : åªéœ€è¦åœ¨ if å†…éƒ¨æ·»åŠ ç¨‹åºğŸ”’ï¼Œä»¥æé«˜ç¨‹åºçš„æ•ˆç‡

```java
public static LazySingleton getInstance(){
        if(instance == null){
            synchronized (LazySingleton.class){
                if (instance == null){
                    instance = new LazySingleton();
                }
            }
        }
        return instance;
    }
```

#### æœ€ç»ˆä»£ç 

```java
class LazySingletion{
	private volatile static LazySingletion instance;
	private static LazySingletion(){

	}

	public static LazySingletion getInstance(){
		if(instance == null){
			synchronized (LazySingletion.class){
				if (instance == null) {
					instance = new LazySingletion();
				}
			}
		}
		return instance;
	}

}
```

### é¥¿æ±‰å¼

> JVM ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç¨‹åºåœ¨ç¼–è¯‘æ—¶å°±åˆ›å»ºäº†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

```java
class HangrySingleton{

	private static HangrySingleton instance = new HangrySingleton();
	private HangrySingleton(){}

	public static HangrySingleton getInstance(){
		return instance;
	}

}
```

### é™æ€å†…éƒ¨ç±»

> æ‡’åŠ è½½çš„æ–¹å¼: å°†å•ä¾‹å¯¹è±¡ æ”¾ç½®åœ¨å†…éƒ¨ç±»ä¸­ï¼Œå½“è°ƒç”¨ getInstance æ–¹æ³•æ—¶ï¼Œéœ€è¦å†…éƒ¨ç±»çš„å±æ€§ï¼Œè¿™æ—¶ä¼šåˆ›å»º å®ä¾‹å¯¹è±¡ï¼Œæ˜¯æ‡’åŠ è½½çš„æ–¹å¼ã€‚

```java
class InnerClassSingleton{
	private static class InnerClass{
		private static InnerClassSingleton instance = new InnerClassSingleton();
	}

	private InnerClassSingleton(){
		// é˜²æ­¢ä½¿ç”¨åå°„æœºåˆ¶è¿›è¡Œåˆ›å»º
		// æ‡’æ±‰æ¨¡å¼ä¸èƒ½è¿›è¡Œé˜²æŠ¤
		if(Inner.instance != null){
            throw new RuntimeException("å·²ç»åˆ›å»ºè¿‡å®ä¾‹ï¼ï½");
        }
	}

	public static InnerClassSingleton getInstance(){
		return InnerClass.instance;
	}
}
```

### Enum å•ä¾‹æ¨¡å¼

> åå°„å®‰å…¨ã€çº¿ç¨‹å®‰å…¨


### åå°„æ”»å‡»

> ä½¿ç”¨åå°„æœºåˆ¶ï¼Œå¯ä»¥è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°ï¼Œå¯èƒ½é€ æˆæ‰“ç ´å•ä¾‹çš„è§„åˆ™ã€‚

```java
private InnerClassSingleton(){
	// é˜²æ­¢ä½¿ç”¨åå°„æœºåˆ¶è¿›è¡Œåˆ›å»º
	// æ‡’æ±‰æ¨¡å¼ä¸èƒ½è¿›è¡Œé˜²æŠ¤
	if(Inner.instance != null){
        throw new RuntimeException("å·²ç»åˆ›å»ºè¿‡å®ä¾‹ï¼ï½");
    }
}
```

## åºåˆ—åŒ–çš„å•ä¾‹æ¨¡å¼

> å°†å¯¹è±¡å­˜å…¥ç¡¬ç›˜ï¼Œè¯»å–çš„å¯¹è±¡å’Œè°ƒç”¨æ–¹æ³•è·å–çš„å¯¹è±¡ä¸ä¸€è‡´ã€‚

- è§£å†³:

1. å¯¹è±¡ä¸­ç»§æ‰¿åºåˆ—åŒ–æ¥å£ `Serializable`
2. æ·»åŠ æ–¹æ³• :  `Object readResolve() throws ObjectStreamException; `
3. æ·»åŠ ç‰ˆæœ¬ğŸ†” : `static final long serialVersionUID = 43L;`

```java
public class InnerSingleton implements Serializable {
    static final long serialVersionUID = 43L;

    private static class Inner{
        private static InnerSingleton instance = new InnerSingleton();
    }

    private InnerSingleton(){
        if(Inner.instance != null){
            throw new RuntimeException("å·²ç»åˆ›å»ºè¿‡å®ä¾‹ï¼ï½");
        }
    }

    public static InnerSingleton getInstance(){
        return Inner.instance;
    }

    Object readResolve() throws ObjectStreamException {
        return Inner.instance;
    }

}
```

- æµ‹è¯•

```java
    @Test
    public void save() throws IOException {
        InnerSingleton instance = InnerSingleton.getInstance();
        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream("InnerSingleton"));
        out.writeObject(instance);
        out.close();
    }

    @Test
    public void read() throws IOException, ClassNotFoundException {
        ObjectInputStream in = new ObjectInputStream(new FileInputStream("InnerSingleton"));
        InnerSingleton innerSingleton = (InnerSingleton) in.readObject();
        in.close();
        Assert.assertEquals(true, InnerSingleton.getInstance() == innerSingleton);
        //é€šè¿‡
    }
```

## Enumç±»å‹åºåˆ—åŒ–

> Enum ç±»å‹å¯ç›´æ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œä¸éœ€è¦è¿›è¡Œä»¥ä¸Šæ“ä½œã€‚

## å…¶ä»–ç¤ºä¾‹

- Spring & JDK
	- java.lang.Runtime => é¥¿æ±‰å¼
	- java.util.Currency  => double check
	- org.springframework.aop.framework.ProxyFactoryBean
	- org.springframework.beans.factory.support.DefaultSingletonBeanRegistry
- Tomcat
	- org.apache.catalina.webresources.TomcatURLStreamHandlerFactory
	
---

## å‚è€ƒå†…å®¹

[ç¨‹åºå‘˜å¿…å¤‡çš„13ç§è®¾è®¡æ¨¡å¼ä½ çœŸçš„æŒæ¡äº†å—ï¼Ÿå…¨å¥—æ•™å­¦è§†é¢‘è®©ä½ å½»åº•å¼„æ‡‚](https://www.bilibili.com/video/BV18a4y147dB?p=1)
